<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GrowAGarden Plant Cost Calculator</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #f0f8f0;
    }
    select, input, button {
      margin: 0.5rem 0;
      padding: 0.5rem;
      font-size: 1rem;
    }
    #result {
      margin-top: 1rem;
      font-weight: bold;
    }
    #correction-section {
      margin-top: 2rem;
      border-top: 1px solid #ccc;
      padding-top: 1rem;
    }
    .msg {
      margin-top: 0.5rem;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>

  <h1>GrowAGarden Plant Cost Calculator</h1>

  <label>Plant:
    <select id="plant">
      <option value="Carrot">Carrot</option>
      <option value="Rose">Rose</option>
      <option value="Sunflower">Sunflower</option>
    </select>
  </label><br>

  <label>Weight (kg):
    <input type="number" id="weight" step="0.01" />
  </label><br>

  <label>Modifiers:
    <select id="modifier" multiple>
      <option value="Organic">Organic</option>
      <option value="Imported">Imported</option>
      <option value="Seasonal">Seasonal</option>
    </select>
  </label><br>

  <button onclick="calculate()">Calculate Price</button>
  <div id="result"></div>

  <div id="correction-section">
    <h3>Suggest a Correction</h3>
    <label>Correct Price ($):
      <input type="number" id="correctPrice" step="0.01" />
    </label><br>
    <button onclick="submitCorrection()">Submit Correction</button>
    <div class="msg" id="correctionMsg"></div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDvMCSyGIAUsMpRE-pDY3uwwMg7IMwmLig",
      authDomain: "growagardenplantcostcalculator.firebaseapp.com",
      databaseURL: "https://growagardenplantcostcalculator-default-rtdb.firebaseio.com",
      projectId: "growagardenplantcostcalculator",
      storageBucket: "growagardenplantcostcalculator.appspot.com",
      messagingSenderId: "410113480248",
      appId: "1:410113480248:web:72badb81206b458ecd38cd",
      measurementId: "G-K7XD9NMRGZ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Trusted starting data
    const startingData = [
      { plant: 'Carrot', modifiers: ['Organic'], weight: 1, price: 3 },
      { plant: 'Rose', modifiers: ['Imported'], weight: 0.5, price: 5 },
      { plant: 'Sunflower', modifiers: [], weight: 2, price: 4 },
    ];

    function normalizeModifiers(mods) {
      return mods.sort().join(',');
    }

    function calculate() {
      const plant = document.getElementById('plant').value;
      const weight = parseFloat(document.getElementById('weight').value);
      const modifierEls = Array.from(document.getElementById('modifier').selectedOptions);
      const modifiers = modifierEls.map(opt => opt.value);

      if (isNaN(weight) || weight <= 0) {
        document.getElementById('result').textContent = 'Enter a valid weight.';
        return;
      }

      const match = startingData.find(entry =>
        entry.plant === plant &&
        normalizeModifiers(entry.modifiers) === normalizeModifiers(modifiers)
      );

      if (match) {
        const price = (match.price / match.weight) * weight;
        document.getElementById('result').textContent = `Estimated Price: $${price.toFixed(2)}`;
      } else {
        document.getElementById('result').textContent = 'No matching data. Please consider submitting a correction.';
      }
    }

    function submitCorrection() {
      const plant = document.getElementById('plant').value;
      const weight = parseFloat(document.getElementById('weight').value);
      const modifierEls = Array.from(document.getElementById('modifier').selectedOptions);
      const modifiers = modifierEls.map(opt => opt.value);
      const correctPrice = parseFloat(document.getElementById('correctPrice').value);
      const correctionMsg = document.getElementById('correctionMsg');

      if (isNaN(weight) || weight <= 0 || isNaN(correctPrice) || correctPrice <= 0) {
        correctionMsg.textContent = 'Please enter valid weight and price.';
        correctionMsg.style.color = 'red';
        return;
      }

      const perKg = correctPrice / weight;

      // Check if it's consistent (within 25%) of existing entries for same plant/modifier
      const matches = startingData.filter(entry =>
        entry.plant === plant &&
        normalizeModifiers(entry.modifiers) === normalizeModifiers(modifiers)
      );

      let valid = false;
      if (matches.length === 0) {
        valid = true; // accept new combination
      } else {
        valid = matches.some(entry => {
          const entryPerKg = entry.price / entry.weight;
          const lower = entryPerKg * 0.75;
          const upper = entryPerKg * 1.25;
          return perKg >= lower && perKg <= upper;
        });
      }

      if (valid) {
        const newEntry = { plant, modifiers, weight, price: correctPrice };
        startingData.push(newEntry);
        db.ref("corrections").push(newEntry);
        correctionMsg.textContent = 'Thank you! Correction accepted and added.';
        correctionMsg.style.color = 'green';
      } else {
        correctionMsg.textContent = 'Correction rejected: seems inconsistent with trusted data.';
        correctionMsg.style.color = 'red';
      }
    }
  </script>
</body>
</html>
