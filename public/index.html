
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GrowAGarden Plant Cost Calculator ‚Äì AI & Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="./logo.png" type="image/png" />
  <link rel="stylesheet" href="style.css">
  <style>
    /* Admin overlay & modal for secure admin visualization */
    #adminModal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(10,10,10,0.5);
      justify-content: center; align-items: center;
    }
    #adminPanel {
      max-width: 90vw; width: 600px; background: #fff; border-radius: 1em;
      box-shadow: 0 12px 25px rgba(34,139,87,.18);
      padding: 2em; position: relative;
    }
    #adminPanel h2 { color: #228b57; }
    #closeAdmin { position: absolute; right: 2em; top: 2em; background: #eee; padding: .5em 1em; border-radius: .5em; cursor: pointer; }
    #adminList { margin: 2em 0; max-height: 260px; overflow: auto; }
    .admin-row { border-bottom: 1px solid #eee; padding: .5em; display: flex; justify-content: space-between; align-items: center; }
    .admin-row:last-child { border-bottom: none; }
    .admin-actions button { margin-left: 0.5em; }
    .trend-chart { width: 100%; height: 150px; margin-top: 1em; }
    .filter-box { margin: 0.5em 0 1.5em; }
    .hidden { display: none !important; }
    #adminLogin {
      position: fixed;
      z-index: 20;
      left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(20,20,20,0.8);
      display: none;
      justify-content: center;
      align-items: center;
    }
    #adminLoginPanel {
      width: 320px; background: white; border-radius: 12px; padding: 2em 2em;
      box-shadow: 0 8px 36px #393;
      text-align: center;
    }
    #adminLoginPanel input { width: 80%; }
    #adminLoginPanel button { width: 60%; }
    @media (max-width:800px) {
      #adminPanel, .calculator { padding: 1em; }
      .trend-chart { height: 100px; }
    }
    /* For admin visual cues */
    .admin-row.highlight { background: #e8fff1; }
    /* Extra context for feedback, etc */
    .feedback-bar { background: #e4f9e7; padding: .7em 1em; margin-top: 1em; border-radius: .5em; color: #15743c; }
    .danger { color: #e41a2e; }
    .success { color: #228b57; }
  </style>
</head>
<body>
  <h1>üåø GrowAGarden Plant Cost Calculator with AI & Admin Panel</h1>
  <div class="calculator" id="mainCalculator">
    <label for="plantType">Plant Type</label>
    <select id="plantType"></select>

    <label for="plantWeight">Weight (kg)</label>
    <input type="number" id="plantWeight" step="0.01" value="1" min="0.01">

    <label for="modifiers">Modifiers (Ctrl/Cmd for multi)</label>
    <select id="modifiers" multiple></select>

    <button id="calculateBtn">üí∞ Calculate Price</button>
    <div class="result" id="priceResult">Estimated Price: ‚Äî</div>
    <div id="confidence"></div>
    <div class="breakdown" id="breakdown"></div>

    <div class="feedback-buttons" id="feedbackButtons" style="display:none;">
      <button id="btnAccurate">‚úîÔ∏è Accurate</button>
      <button id="btnInaccurate">‚ùå Not Accurate</button>
    </div>

    <div id="correctionInput" style="display:none;">
      <label for="correctPrice">Enter Correct Price (Robux):</label>
      <input type="number" id="correctPrice" min="1" step="0.01" />
      <button id="submitCorrection">Submit Correction</button>
    </div>
    <button id="adminButton" style="margin-top:1.5em; width:auto; background:#19b081;">Admin Panel</button>
  </div>

  <footer>
    Not affiliated with Roblox or GrowAGarden. Made by fans üå±<br/>
    <small>Validation: AI learning and admin-reviewed trusted corrections. Strict rules enforced. Modifiers/rare/seasonal plants have value floors.</small>
  </footer>
  <!-- Admin Login -->
  <div id="adminLogin">
    <div id="adminLoginPanel">
      <h2>Admin Login</h2>
      <input type="password" id="adminPassword" placeholder="Password" /><br /><br />
      <button id="adminLoginBtn">Log In</button>
      <div id="adminLoginMsg" style="margin-top:1em; min-height:1.5em;" class="danger"></div>
    </div>
  </div>
  <!-- Admin Modal/Panel -->
  <div id="adminModal">
    <div id="adminPanel">
      <span id="closeAdmin">Close</span>
      <h2>Admin Trusted Data & Trend</h2>
      <div class="filter-box">
        Filter: <input id="adminFilter" type="text" placeholder="Plant name/type/modifier...">
      </div>
      <div id="adminList"></div>
      <canvas id="trendChart" class="trend-chart"></canvas>
      <div style="margin-top:1em;">
        <strong>Correction Queue:</strong>
        <ul id="correctionQueue" style="list-style:none; padding-left:0;"></ul>
      </div>
    </div>
  </div>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <!-- Chart.js for trend graphing -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- The main logic and behavior -->
  <script>
  // ------------------ Configuration Data -------------------
  // You may modify this base data as needed!
  const PLANTS = [
    { type: "Apple", base: 100 },
    { type: "Banana", base: 110 },
    { type: "Blueberry", base: 180 },
    { type: "Celestlberry", base: 2000 },
    { type: "Coconut", base: 100 },
    { type: "Corn", base: 50 },
    { type: "Dragonfruit", base: 120 },
    { type: "Durian", base: 500 },
    { type: "Strawberry", base: 63 },
    { type: "Mushroom", base: 10000 },
    { type: "Orchid", base: 3000 },
    { type: "Rose", base: 250 }
    // Add more as needed
  ];
  // Alphabetical
  PLANTS.sort((a,b) => a.type.localeCompare(b.type));
  const MODIFIERS = [
    { value:"rainbow", label:"üåà Rainbow", multiplier:1.5 },
    { value:"gold", label:"ü•á Gold", multiplier:2.0 },
    { value:"shocked", label:"‚ö° Shocked", multiplier:2.1 },
    { value:"frozen", label:"‚ùÑÔ∏è Frozen", multiplier:1.6 },
    { value:"wet", label:"üíß Wet", multiplier:1.1 },
    { value:"chilled", label:"üßä Chilled", multiplier:1.1 },
    { value:"choc", label:"üç´ Choc", multiplier:1.4 },
    { value:"moonlit", label:"üåô Moonlit", multiplier:1.4 },
    { value:"bloodlit", label:"ü©∏ Bloodlit", multiplier:1.6 },
    { value:"celestial", label:"‚ú® Celestial", multiplier:5 },
    { value:"disco", label:"üï∫ Disco", multiplier:3.5 },
    { value:"zomb", label:"üßü Zomb", multiplier:1.3 },
    { value:"plasma", label:"üîã Plasma", multiplier:1.7 },
    { value:"rare", label:"‚≠ê Rare", multiplier:2.2 },
    { value:"seasonal", label:"üéâ Seasonal", multiplier:1.13 },
    { value:"trimmed", label:"‚úÇÔ∏è Trimmed", multiplier:0.93 },
    { value:"dried", label:"üåæ Dried", multiplier:0.64 }
  ];
  // Validation rules (strict mins, accepted margin %, etc)
  const STRICT_MODIFIER_MIN = {
    rare: 900,
    dried: 60,
  };
  const CORRECTION_MARGIN = 0.2; // ¬±20%

  // Admin password (should be secure, non-trivial, and stored securely in production)
  const ADMIN_PASS = "GrowAGardenAdmin2024!";

  // ------------------ Firebase Setup ---------------------
  const firebaseConfig = {
    apiKey: "AIzaSyDvMCSyGIAUsMpRE-pDY3uwwMg7IMwmLig",
    authDomain: "growagardenplantcostcalculator.firebaseapp.com",
    databaseURL: "https://growagardenplantcostcalculator-default-rtdb.firebaseio.com",
    projectId: "growagardenplantcostcalculator",
    storageBucket: "growagardenplantcostcalculator.appspot.com",
    messagingSenderId: "410113480248",
    appId: "1:410113480248:web:72badb81206b458ecd38cd",
    measurementId: "G-K7XD9NMRGZ"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const PLANTS_COLLECTION = db.collection("plant_prices");
  const CORRECTION_QUEUE = db.collection("correction_queue");

  // ------------------ UI Initialization --------------------
  // Populate plant types and modifiers
  const plantTypeSel = document.getElementById("plantType");
  const modifiersSel = document.getElementById("modifiers");
  PLANTS.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.type;
    opt.textContent = p.type;
    plantTypeSel.appendChild(opt);
  });
  MODIFIERS.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m.value;
    opt.textContent = m.label;
    modifiersSel.appendChild(opt);
  });

  // ------------------ State & Local AI ---------------------
  let trustedData = {}; // PlantType_ModStrings -> {base, confidence, history:[], confirmed:[]}
  let correctionQueue = []; // {plant,weight,mods,price,submitted}
  let adminLoggedIn = false;

  // Helper to get modifier string (sorted for canonical)
  function modString(mods) {
    return mods.slice().sort().join(",");
  }

  // Load trusted/learned data from Firebase (and mirror to localStorage)
  async function loadTrustedData() {
    const snapshot = await PLANTS_COLLECTION.get();
    trustedData = {};
    snapshot.forEach(doc => {
      trustedData[doc.id] = doc.data();
    });
    // Load correction queue
    const corrSnap = await CORRECTION_QUEUE.get();
    correctionQueue = [];
    corrSnap.forEach(doc => correctionQueue.push({...doc.data(), id: doc.id}));
  }
  function storeTrustedLocal() {
    localStorage.setItem('trustedPlantData', JSON.stringify(trustedData));
  }
  function loadTrustedLocal() {
    trustedData = JSON.parse(localStorage.getItem('trustedPlantData') || '{}');
  }

  // ------------------ Price Calculation Logic ---------------------
  function calcPlantPrice(plantType, weight, modsArr, trusted = null) {
    const plant = PLANTS.find(p => p.type === plantType);
    let base = plant ? plant.base : 100;
    if (trusted && trusted.base) {
      base = trusted.base;
    }
    let price = base * weight;
    let multBreakdown = [];
    modsArr.forEach(modVal => {
      const m = MODIFIERS.find(m => m.value === modVal);
      if (m) {
        multBreakdown.push(`${m.label}√ó${m.multiplier}`);
        price *= m.multiplier;
      }
    });
    // Strict minimums for some modifiers
    modsArr.forEach(modVal => {
      if (typeof STRICT_MODIFIER_MIN[modVal] === "number" && price < STRICT_MODIFIER_MIN[modVal]) {
        price = STRICT_MODIFIER_MIN[modVal];
      }
    });
    return {
      price: Math.round(price*100)/100,
      breakdown: {
        base, weight, mods: modsArr, multBreakdown,
        strictInfo: modsArr.filter(m => STRICT_MODIFIER_MIN[m]).map(m =>
          `Min for ${m}: ${STRICT_MODIFIER_MIN[m]}`).join(" | ")
      }
    };
  }

  // --- Price correction plausibility: within ¬±20% of trusted, modifier restrictions, no nonsense (e.g., 1 Robux for rare) ---
  function validateCorrection(plantType, weight, modsArr, userPrice, trusted) {
    if (userPrice <= 0) return {ok:false, reason:"Invalid price."};
    const aiEst = calcPlantPrice(plantType, weight, modsArr, trusted).price;
    // Margin
    if (trusted && trusted.base) {
      const avg = aiEst;
      const lower = avg * (1 - CORRECTION_MARGIN);
      const upper = avg * (1 + CORRECTION_MARGIN);
      if (userPrice < lower || userPrice > upper) {
        return {ok:false, reason:`Must be within ${Math.round(CORRECTION_MARGIN*100)}% of trusted: [${lower.toFixed(2)}‚Äì${upper.toFixed(2)} Robux]`};
      }
    }
    // Modifier strict rules
    for (const m of modsArr) {
      if (STRICT_MODIFIER_MIN[m] && userPrice < STRICT_MODIFIER_MIN[m]) {
        return {ok:false, reason:`Modifier "${m}" requires at least ${STRICT_MODIFIER_MIN[m]} Robux`};
      }
    }
    // Not absurdly low
    if (userPrice < 0.08) return {ok:false, reason:"Price too low for any plant."};
    return {ok:true, reason:"Accepted."};
  }

  // ------------------ UI/Event Logic ---------------------
  let currentCalc = null;

  function displayResult(res) {
    document.getElementById("priceResult").textContent =
      `Estimated Price: ${res.price} Robux`;
    document.getElementById("breakdown").innerHTML =
      `<b>Details:</b><br>
      Base: ${res.breakdown.base} Robux/kg<br>
      Weight: ${res.breakdown.weight}kg<br>
      Modifiers: ${res.breakdown.mods.map(m=>MODIFIERS.find(x=>x.value===m)?.label).join(", ")||"None"}<br>
      Multiplier: ${res.breakdown.multBreakdown.length?res.breakdown.multBreakdown.join(" √ó "):"N/A"}<br>
      ${res.breakdown.strictInfo?'<span style="color:#cb902c">'+res.breakdown.strictInfo+'</span>':''}`;
  }

  // --- Calculate button
  document.getElementById("calculateBtn").onclick = function() {
    const plantType = plantTypeSel.value;
    const weight = parseFloat(document.getElementById("plantWeight").value);
    const modsArr = Array.from(modifiersSel.selectedOptions).map(opt=>opt.value);
    if (!plantType || isNaN(weight) || weight <= 0) {
      document.getElementById("priceResult").innerText = "‚ùó Enter a valid weight and plant.";
      document.getElementById("feedbackButtons").style.display='none';
      document.getElementById("correctionInput").style.display='none';
      document.getElementById("confidence").innerText = '';
      document.getElementById("breakdown").innerText = '';
      return;
    }
    const trusted = trustedData[plantType+"|"+modString(modsArr)] || trustedData[plantType] || null;
    const res = calcPlantPrice(plantType, weight, modsArr, trusted);
    currentCalc = { plantType, weight, modsArr, estimated:res.price };
    displayResult(res);

    // Show confidence (confirmation count if any)
    let conf = trusted && trusted.confidence ? trusted.confidence : 0;
    document.getElementById("confidence").innerHTML =
      conf ? `<b>AI Confidence:</b> ${conf} confirmation${conf==1?'':'s'}` : 'AI Confidence: (no data yet)';
    document.getElementById("feedbackButtons").style.display = 'flex';
    document.getElementById("correctionInput").style.display = 'none';
    document.getElementById("correctPrice").value = '';
  };

  // --- Feedback accurate
  document.getElementById("btnAccurate").onclick = async function() {
    if (!currentCalc) return;
    const key = currentCalc.plantType + "|" + modString(currentCalc.modsArr);
    // Add a confirmation to trusted data or create entry
    if (!trustedData[key]) {
      trustedData[key] = {
        base: currentCalc.estimated/currentCalc.weight,
        confidence: 1,
        history: [currentCalc.estimated],
        confirmed: [currentCalc.estimated]
      };
    } else {
      let d = trustedData[key];
      d.confidence = (d.confidence||0) + 1;
      d.history = d.history || [];
      d.confirmed = d.confirmed || [];
      d.base = (d.base*(d.confidence-1) + (currentCalc.estimated/currentCalc.weight)) / d.confidence;
      d.history.push(currentCalc.estimated);
      d.confirmed.push(currentCalc.estimated);
    }
    // Persist
    await PLANTS_COLLECTION.doc(key).set(trustedData[key]);
    storeTrustedLocal();
    alert("Thanks! Your confirmation has improved our AI.");
    document.getElementById("calculateBtn").click();
  };

  // --- Feedback inaccurate
  document.getElementById("btnInaccurate").onclick = function() {
    document.getElementById("correctionInput").style.display = 'block';
    document.getElementById("correctionInput").scrollIntoView({behavior:'smooth'});
  };

  // --- Correction submission
  document.getElementById("submitCorrection").onclick = async function() {
    if (!currentCalc) return;
    const correction = parseFloat(document.getElementById("correctPrice").value);
    if (isNaN(correction) || correction<=0) return alert("Enter a valid price (Robux, numeric)");
    const key = currentCalc.plantType + "|" + modString(currentCalc.modsArr);
    const validation = validateCorrection(currentCalc.plantType, currentCalc.weight, currentCalc.modsArr, correction, trustedData[key]||trustedData[currentCalc.plantType]||null);
    if (!validation.ok) return alert("Correction rejected: "+validation.reason);
    // Send to admin queue, not overwrite trusted immediately
    await CORRECTION_QUEUE.add({
      plantType: currentCalc.plantType,
      weight: currentCalc.weight,
      mods: currentCalc.modsArr,
      price: correction,
      submitted: (new Date).toISOString()
    });
    alert("Correction submitted for admin review. Thanks for helping improve the AI!");
    document.getElementById("correctionInput").style.display = 'none';
  };

  // ------------------- Admin Panel Security & Logic --------------------
  function showAdminLogin(show) {
    document.getElementById("adminLogin").style.display = show?'flex':'none';
    document.getElementById("adminPassword").value = '';
    document.getElementById("adminLoginMsg").innerText = '';
  }

  document.getElementById("adminButton").onclick = () => {
    if (adminLoggedIn) {
      displayAdminPanel();
    } else {
      showAdminLogin(true);
    }
  };
  document.getElementById("closeAdmin").onclick = () => {
    document.getElementById("adminModal").style.display = 'none';
  };
  document.getElementById("adminLoginBtn").onclick = ()=>{
    const pw = document.getElementById("adminPassword").value;
    if (pw===ADMIN_PASS) {
      adminLoggedIn = true;
      showAdminLogin(false);
      displayAdminPanel();
    } else {
      document.getElementById("adminLoginMsg").innerText = "Incorrect password.";
    }
  };
  // Keyboard: Enter for admin login
  document.getElementById("adminPassword").addEventListener("keydown", function(e){
    if (e.key==="Enter") document.getElementById("adminLoginBtn").click();
  });

  async function displayAdminPanel() {
    // Load latest
    await loadTrustedData();
    storeTrustedLocal();
    // List trusted
    const adminList = document.getElementById("adminList");
    adminList.innerHTML = "";
    let filterText = document.getElementById("adminFilter").value?.toLowerCase()||"";
    Object.entries(trustedData)
      .filter(([key,data]) =>
        !filterText ||
        key.toLowerCase().includes(filterText) ||
        (data.mods && data.mods.join(",").includes(filterText)) )
      .sort((a,b)=> a[0].localeCompare(b[0]))
      .forEach(([key,data])=>{
        const e = document.createElement("div");
        e.className = "admin-row";
        e.innerHTML =
          `<span><b>${key}</b>
            <span class="success">AvgBase: ${data.base ? Math.round(data.base*100)/100 : "-"}</span>
            <span>Conf:${data.confidence || "0"} | Entries:${data.history?.length||"0"}</span>
          </span>
          <span class="admin-actions">
            <button onclick='overrideBase("${key}")'>Override</button>
            <button onclick='deleteTrusted("${key}")'>Delete</button>
          </span>`;
        adminList.appendChild(e);
      });
    // Trending chart
    renderTrendChart();
    // Correction queue
    const queueElem = document.getElementById("correctionQueue");
    queueElem.innerHTML = "";
    correctionQueue.forEach(corr=>{
      const li = document.createElement("li");
      li.innerHTML = `<b>${corr.plantType}|${modString(corr.mods||[])}</b> (Weight ${corr.weight}kg): <span class="danger">${corr.price} Robux</span> <button onclick='approveCorrection("${corr.id}")'>Approve</button> <button onclick='rejectCorrection("${corr.id}")'>Reject</button>`;
      queueElem.appendChild(li);
    });
    // Modal up
    document.getElementById("adminModal").style.display = 'flex';
  }
  document.getElementById("adminFilter").oninput = displayAdminPanel;
  // --- Global for admin actions (for inline onclick) ---
  window.overrideBase = async function(key) {
    const val = prompt("Override base value (Robux/kg for this plant+mods)?");
    if (val && !isNaN(parseFloat(val))) {
      trustedData[key].base = parseFloat(val);
      await PLANTS_COLLECTION.doc(key).set(trustedData[key]);
      storeTrustedLocal();
      alert("Base value overridden.");
      displayAdminPanel();
    }
  };
  window.deleteTrusted = async function(key) {
    if (!confirm("Delete trusted entry?")) return;
    await PLANTS_COLLECTION.doc(key).delete();
    delete trustedData[key];
    storeTrustedLocal();
    displayAdminPanel();
  };
  window.approveCorrection = async function(id) {
    // Find, promote to trusted, and delete from queue
    const corr = correctionQueue.find(x=>x.id===id);
    if (corr) {
      const key = corr.plantType + "|" + modString(corr.mods);
      trustedData[key] = {
        base: corr.price/corr.weight,
        confidence: 1,
        history: [corr.price],
        confirmed: [corr.price]
      };
      await PLANTS_COLLECTION.doc(key).set(trustedData[key]);
      await CORRECTION_QUEUE.doc(id).delete();
      alert("Correction approved and promoted to trusted.");
      displayAdminPanel();
    }
  };
  window.rejectCorrection = async function(id) {
    if (!confirm("Reject this correction?")) return;
    await CORRECTION_QUEUE.doc(id).delete();
    alert("Correction rejected and removed from queue.");
    displayAdminPanel();
  };

  // -- Trend chart (Chart.js)
  let trendChartInstance = null;
  function renderTrendChart() {
    const ctx = document.getElementById("trendChart").getContext("2d");
    // Collect all price histories
    let labels = [], values = [];
    Object.entries(trustedData).forEach(([key, data])=>{
      if (data && data.history && data.history.length>0) {
        labels.push(key);
        values.push(data.history[data.history.length-1]);
      }
    });
    if (trendChartInstance) trendChartInstance.destroy();
    trendChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels, datasets: [{ label: "Latest Trusted Prices", backgroundColor:'#34c274', data: values }]
      },
      options: { plugins:{legend:{display:!1}}, scales:{x:{ticks:{autoSkip:false}}} }
    });
  }

  // Initial load and calculation
  (async function(){
    await loadTrustedData();
    document.getElementById("calculateBtn").click();
  })();

  // Full plant list in dropdown is always alphabetical for user
  </script>
</body>
</html>
