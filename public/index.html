import { useState, useEffect } from "react";

const mutationMultipliers = {
  Golden: 20,
  Rainbow: 50,
  None: 1,
};

const environmentStacks = {
  Shocked: 99,
  Frozen: 9,
  Wet: 1,
  Chilled: 1,
  Chocolate: 1,
  Moonlit: 1,
  Disco: 124,
  Celestial: 119,
  Bloodlit: 3,
  Zombified: 24,
  Plasma: 4,
};

const restrictedGrowthMutations = ["Golden", "Rainbow"];
const restrictedEnvironmentals = ["Wet", "Chilled", "Frozen"];

export default function GrowAGardenCalculator() {
  const [baseValue, setBaseValue] = useState(1);
  const [growthMutation, setGrowthMutation] = useState("None");
  const [selectedStacks, setSelectedStacks] = useState<string[]>([]);
  const [totalValue, setTotalValue] = useState(0);
  const [warnings, setWarnings] = useState<string[]>([]);

  useEffect(() => {
    const multiplier = mutationMultipliers[growthMutation] || 1;
    const stackSum = selectedStacks.reduce((sum, key) => sum + (environmentStacks[key] || 0), 0);
    const result = baseValue * multiplier * (1 + stackSum);
    setTotalValue(result);
  }, [baseValue, growthMutation, selectedStacks]);

  useEffect(() => {
    const newWarnings: string[] = [];

    const activeRestrictedEnvironmentals = restrictedEnvironmentals.filter(e => selectedStacks.includes(e));
    if (activeRestrictedEnvironmentals.length > 1) {
      newWarnings.push("Only one of Wet, Chilled, or Frozen may be active at a time.");
    }

    if (growthMutation === "Golden" && selectedStacks.includes("Rainbow")) {
      newWarnings.push("You can only apply either Golden or Rainbow, not both.");
    } else if (growthMutation === "Rainbow" && selectedStacks.includes("Golden")) {
      newWarnings.push("You can only apply either Golden or Rainbow, not both.");
    }

    setWarnings(newWarnings);
  }, [growthMutation, selectedStacks]);

  const toggleStack = (key: string) => {
    setSelectedStacks(prev =>
      prev.includes(key) ? prev.filter(s => s !== key) : [...prev, key]
    );
  };

  return (
    <div className="p-4 max-w-xl mx-auto">
      <h1 className="text-2xl font-bold mb-4">GrowAGarden Plant Cost Calculator</h1>

      <div className="mb-4">
        <label className="block mb-1 font-medium">Base Value:</label>
        <input
          type="number"
          value={baseValue}
          onChange={(e) => setBaseValue(Number(e.target.value))}
          className="border rounded px-2 py-1 w-full"
        />
      </div>

      <div className="mb-4">
        <label className="block mb-1 font-medium">Growth Mutation:</label>
        <select
          value={growthMutation}
          onChange={(e) => setGrowthMutation(e.target.value)}
          className="border rounded px-2 py-1 w-full"
        >
          {Object.keys(mutationMultipliers).map((key) => (
            <option key={key} value={key}>{key}</option>
          ))}
        </select>
      </div>

      <div className="mb-4">
        <label className="block mb-1 font-medium">Environmental Stacks:</label>
        <div className="grid grid-cols-2 gap-2">
          {Object.entries(environmentStacks).map(([key, val]) => (
            <label key={key} className="flex items-center">
              <input
                type="checkbox"
                checked={selectedStacks.includes(key)}
                onChange={() => toggleStack(key)}
                className="mr-2"
              />
              {key} ({val}x)
            </label>
          ))}
        </div>
      </div>

      {warnings.length > 0 && (
        <div className="bg-yellow-100 text-yellow-800 p-2 mb-4 rounded">
          {warnings.map((w, idx) => (
            <div key={idx}>{w}</div>
          ))}
        </div>
      )}

      <div className="text-lg font-semibold">
        Total Value: <span className="text-green-600">{totalValue.toLocaleString()}x</span>
      </div>
    </div>
  );
}
